<!DOCTYPE html>
<html>
  <head>
    <title>Review Exam</title>
    <!--<link rel="stylesheet" href="style.css">-->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  </head>
  <body>
    <h1 id="header"></h1>
    <main id="reviewDiv">
      <button id="goBackHome" onclick = goBack()>GO BACK</button>
    </main>   

    <script>

      const urlParams = new URLSearchParams(window.location.search);
      var requestType = 'ReviewExamTeacherFTM';
      const studentExamsID = urlParams.get('studentExamsID');
      
      var questions;
      var pointsAndComments = [];

      function displayExams(){
        const data = {studentExamsID, requestType};

        const options = {
          method:'POST',
          headers: {
              "Content-type": "application/json; charset=UTF-8"
          },
          body: JSON.stringify(data)
        };
        
        fetch('http://cs490testcenter.ddns.net:50000/portal/frontBrowser.php', options)
        .then(response => {
          return response.json();
        })
        .then(data => {
          console.log(data);
          questions = data.answers;

          const header = document.getElementById("header");
          header.innerHTML = data.examData.examName;

          const points = document.createTextNode("Grade: " + data.examData.PointsEarned + "/" + data.examData.TotalPoints);
          document.getElementById('reviewDiv').insertBefore(points, document.getElementById("goBackHome"));
          document.getElementById('reviewDiv').insertBefore(document.createElement("br"), document.getElementById("goBackHome"));
          document.getElementById('reviewDiv').insertBefore(document.createElement("br"), document.getElementById("goBackHome"));

          for(let i = 0; i < data.answers.length; i++){
            const div = document.createElement("div");
            const question = document.createElement("label");
            question.setAttribute("class", "container")

            question.appendChild(document.createTextNode("Question " + (i+1)));
            question.appendChild(document.createElement("br"));

            question.appendChild(document.createTextNode("Points: "));
            const pointsEarned = document.createElement("input");
            pointsEarned.setAttribute("value", data.answers[i].pointsCorrect);
            pointsEarned.setAttribute("size", 3);
            question.appendChild(pointsEarned);

            question.appendChild(document.createTextNode(" / " + data.answers[i].points));
            question.appendChild(document.createElement("br"));

            question.appendChild(document.createTextNode("Type: " + data.answers[i].type));
            question.appendChild(document.createElement("br"));

            question.appendChild(document.createTextNode("Difficulty: " + data.answers[i].difficulty));
            question.appendChild(document.createElement("br"));

            question.appendChild(document.createTextNode("Question: " + data.answers[i].question));
            question.appendChild(document.createElement("br"));

            input = document.createElement("textarea");
            input.readOnly = "true";
            input.setAttribute("rows", "15");
            input.setAttribute("cols", "95");
            input.innerHTML = data.answers[i].answer;
            
            question.appendChild(document.createElement("br"));
            question.appendChild(input);

            question.appendChild(document.createElement("br"));
            question.appendChild(document.createTextNode("Comments: "));

            question.appendChild(document.createElement("br"));
            const comments = document.createElement("textarea");
            comments.setAttribute("rows", "5");
            comments.setAttribute("cols", "95");
            comments.innerHTML = data.answers[i].comments;
            question.appendChild(comments);

            div.appendChild(question);

            document.getElementById("reviewDiv").insertBefore(div, document.getElementById("goBackHome"));
            document.getElementById("reviewDiv").insertBefore(document.createElement("br"), document.getElementById("goBackHome"));
            document.getElementById("reviewDiv").insertBefore(document.createElement("br"), document.getElementById("goBackHome"));

            const pac = {pointsEarned, comments};

            pointsAndComments.push(pac)
          }
        })
        .catch((error) => {
          console.error('Error:', error);
        });
                
      };
      function goBack(){
        //console.log(questions);
        //console.log(pointsAndComments);

        const gradeChangesFormatted = [];

        for(let i = 0; i<questions.length; i++){
          gradeChangeFormatted = {
            studentExamsID: questions[i].studentExamsID,
            questionID: questions[i].questionID,
            points: pointsAndComments[i].pointsEarned.value,
            comments: pointsAndComments[i].comments.value
          }
          gradeChangesFormatted.push(gradeChangeFormatted);
        }

        console.log(gradeChangesFormatted);

        requestType = "ChangeGradesFTM"
        const data = {gradeChangesFormatted, requestType};

        const options = {
          method:'POST',
          headers: {
              "Content-type": "application/json; charset=UTF-8"
          },
          body: JSON.stringify(data)
        };

        fetch('http://cs490testcenter.ddns.net:50000/portal/frontBrowser.php', options)
        .then(response => {
          return response.json();
        })
        .then(data => {
          if(data.didWork == 1){
            location.assign('http://cs490testcenter.ddns.net:50000/portal/t/ReviewAndGradeExams.html');
          }
        })
        .catch((error) => {
          console.error('Error:', error);
        });
      }
      displayExams();
    </script>
    
  </body>
</html> 